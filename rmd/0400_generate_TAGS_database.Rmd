---
title:  "generate_TAGS"
date:   "`r format(Sys.Date(), '%d_%b_%Y')`" 
TAGS:  yaml,tags,lapply examples,utils,data.table
---



## Definitions 
  
  * `files` = char[] of all files to be process for TAGS
  * `headers` = named list of yaml, one element for each file in files. Content
    includes all yaml specifications, include  if exits.
  * `TAGS` = named list, each element has name = its file name; contents are
    chr[1] of contents of `TAGS:`  ( `tag1,tag2,tag3...` )


#  ==========
#  load_all()
#   Be sure in vim and R in same wd
#    USE   ,rd  setwd("~/code/publish_project/rmd/")
```{r for_real}
load_all()
library(data.table)
library(rmarkdown)
library(TAGS)


# relative to project root, 
here()
dir  <- here("rmd")
dir


# testing ##########
dir = "~/code/try_things_here/rmd"
# testing ##########

```

```{r begin}

{
begin  <- Sys.time()
rmd_pattern  <- '[.][Rr](md|markdown)$'
md_pattern  <- '[.][Rr]?(md|markdown)$'

files  <- TAGS::get_files(path = dir, pattern = rmd_pattern)
head(files)


file_headers  <- TAGS::get_file_headers(files)
s

# given list of files
#  return a named list, one element for each file.  Each element has chr[1]
#  contents of TAGS:  


# TAGS is a named list, each element has
# ... name, chr[1], file_name
# ... value,chr[1], contents of tags "tag1, tag2, ..."
files_TAGS_lineq  <- lapply(headers, get_file_TAGS_line)

end  <- Sys.time()
print(end - begin)
}
TAGS_lines
```

```{r data_table}

dt  <- data.table(files = basename(files),
                  TAGS = TAGS)

dt

head(dt, n=10L)
# 
```



```{r process}

# Step 1, remove NULL
f  <- function(e) ifelse(is.null(e), return(NA), return(e))
dt  <- dt[,.(files, TAGS = lapply(TAGS, f)) ]
dt

# Step 2, NA_character_
# Step 2  use NA_character_ version of NA
#base::strsplit() works with NA_character_, but not NA
f  <- function(e) ifelse(is.character(e),return(e), return(c(NA_character_)))
dt  <- dt[, .(files, TAGS = lapply(TAGS, f)) ]
dt

# Step 3, split and normalize
split_up  <- function(e) base::strsplit(e, split="[,]")
dt  <- dt[, .(TAGS = unlist(lapply(TAGS, split_up) )) , by=files]
head(dt, n=100L)
dt[, .N]

```


```{r save_to_file  }
file_name  <- paste0("TAGS_", format(Sys.Date(), "%d%b%Y"))
file_name

saveRDS(dt, file_name)

# retrieve
lines  <- readRDS(file_name)
lines

```
```{r order}
dt[!is.na(TAGS), sort(TAGS)]
dt[!is.na(TAGS), by=file] 
```




```{r render, eval=F, include=F}


## GOOD PRACTICE:
#  Refer to files relative to project root, which should remain as working dir.
#  So why using `here` ?

file  <-"generate_TAGS.Rmd"
file  <- here("rmd", file)
file

# debugging
options(tinytex.verbose = TRUE)
## Want github to display nicely rendered output?
##  *  include md_format
#   *  include output_dir = "out"
#   *  if .gitignore balks,  then add !out/**   to close .github
rmarkdown::render(file,
                  #output_format = "pdf_document",
                  #output_format = "html_document",
                  output_format=c("html_document",    # if want both
                                  "md_document"),
                  #output_dir = "out",
                  output_file = "out")

```




